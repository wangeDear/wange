# 什么是事务

对于mysql数据库，其中InnoDB引擎才支持事务，MyISAM引擎是不支持事务的。

同一个事务内的数据操作，要么全部失败要么全部成功，失败需要回滚数据，要所有数据操作成功了才提交事务，否则有任一一个数据操作失败了，都将所有的数据操作进行回滚。

例如用户付款下单购买商品，购买成功后需要更新订单状态再扣减库存，这两个操作必须都成功或者失败，否则就会出现问题，如果状态更新了库存没有进行扣减，会发生多卖的问题，没有更新订单状态扣减了库存就会发生少卖的情况。

事务有四个特性，分别是ACID，一致性、隔离性、持久性、原子性。事务的隔离级别属于隔离性。

# 事务隔离级别

每个系统都有可能出现业务并发的情况，出现同一时间对同一数据进行操作的情形，这时事务与事务之间的数据可见性，数据之间隔离性就需要在开发阶段进行考虑。

比如现在转账的业务场景，用户A给用户B转账，创建了一个事务，还未进行事务提交，与此同时用户A同时进行了消费需要做余额扣减，又创建了一个事务，如果此时不考虑事务之前的数据隔离性的话，就会出现问题，用户A很有可能获取到转账之前的余额进行消费扣减，导致数据余额不正确。

mysql提供了四种事务隔离级别，分别是读未提交、读已提交、可重复读、串行化。

## mysql配置事务隔离级别

> mysql默认的事务隔离级别为**可重复读**

### 查询当前事务隔离级别
```mysql
show variables like 'transaction_isolation';
```
![](https://blog-1258875084.cos.ap-guangzhou.myqcloud.com/picgo-eve202210111347816.png)

### 配置事务隔离级别

```mysql
set [作用域] transaction isolation level [事务隔离级别]
```

- 作用域：global、session
- 事务隔离级别：READ UNCOMMITTED | READ COMMITTED | REPEATABLE READ | SERIALIZABLE

```mysql
set global transaction isolation level read committed;
```

## 读未提交

事务A与事务B同时创建，事务A没有提交，事务A在没有提交事务之前所有的操作对事务B来说都是可见的，事务B发起查询获取到了事务A还没提交的数据，发生了脏读，同时也会导致不可重复读、幻读等情况。

## 读已提交

事务A与事务B同时创建，事务A已提交，事务B在事务A提交前后分别查询获取到了不同的数据，出现不可重复读的情况，也有可能出现幻读的情况，事务A在事务B之前提交，事务B发生数据变动，而后事务A再来读取时就获取到了事务B后面提交的数据，发生了幻读。

## 可重复读

事务A、事务B先后创建，事务A对数据进行操作更新，事务B无论在事务A前后读取的数据都是一致的，不会出现不可重复读的问题，但事务A发生数据插入的操作，事务B在此前后查询的结果还是会出现不一致的情况，这就是幻读。

### 实现方式

mysql数据库表中的行记录除了保存有主键以及数据之外，还有一列保存事务id，每个事务对数据进行操作变更都会增加，等于新增一个版本。
再利用MVVC（多版本并发控制）的方式实现，首先在每个事务创建前，生成创建一个带有事务id全局性的快照，查询数据时会再当前对应事务id版本的快照进行查询，只要事务id不发生变化，那在当前事务所有的查询不管其他事务有没提交，获取的数据都是一致的。

## 串行化

将事务顺序执行，必须等待上一个事务执行完成才执行下一各事务，隔离性最高，但性能极差。

